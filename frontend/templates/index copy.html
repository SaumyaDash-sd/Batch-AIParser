<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatchProcessor Pro</title>
    <link rel="icon" type="image/x-icon" href="https://www.justdial.com/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff7b00 0%, #1e3a8a 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            position: relative;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #ff7b00 0%, #1e3a8a 100%);
            position: relative;
            overflow: hidden;
        }

        .login-screen::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
            }

            100% {
                transform: translateY(-100px) rotate(360deg);
            }
        }

        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 450px;
            width: 90%;
            animation: slideUp 0.8s ease-out;
            z-index: 10;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.05);
            }
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin: 0 auto 1rem;
            display: block;
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            color: white;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-label {
            color: white;
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #ff7b00;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(255, 123, 0, 0.3);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }


        select option {
            color: black;
        }

        .form-error {
            color: #ffcdd2;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(45deg, #ff7b00, #1e3a8a);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .login-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover:before {
            left: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .dashboard {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, #ff7b00 0%, #1e3a8a 100%);
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 20;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: cover;
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
        }

        .nav-item {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .profile-menu {
            position: relative;
            z-index: 30;
        }

        .profile-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff7b00, #1e3a8a);
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-btn:hover {
            transform: scale(1.1);
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            min-width: 250px;
            z-index: 100;
        }

        .profile-dropdown.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-info {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .profile-info strong {
            color: #1e3a8a;
        }

        .logout-btn {
            width: 100%;
            padding: 0.5rem;
            background: linear-gradient(45deg, #ff7b00, #1e3a8a);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .main-content {
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .section-title {
            color: white;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .step.completed:not(:last-child)::after {
            background: #ff7b00;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background: linear-gradient(45deg, #ff7b00, #1e3a8a);
            transform: scale(1.2);
        }

        .step.completed .step-circle {
            background: #ff7b00;
        }

        .step-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .step.active .step-label {
            color: white;
            font-weight: 600;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: slideInRight 0.5s ease-out;
        }

        .form-navigation {
            text-align: right;
            margin-top: 2rem;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .file-upload:hover {
            border-color: #ff7b00;
            background: rgba(255, 123, 0, 0.1);
        }

        .file-upload.drag-over {
            border-color: #ff7b00;
            background: rgba(255, 123, 0, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background: #6c757d !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff7b00, #1e3a8a);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .data-table-container {
            overflow-x: auto;
            max-height: 400px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .data-table td ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .slider-container {
            flex-grow: 1;
        }

        .slider-label {
            color: white;
            margin-bottom: 0.5rem;
            display: block;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff7b00;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .slider-value-input {
            width: 80px;
            text-align: center;
        }

        .result-container {
            color: white;
        }

        .result-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.5s ease-out;
        }

        .summary-card-title {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .summary-card-value {
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffb37c;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ff7b00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-out;
            min-width: 250px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-error {
            background: linear-gradient(135deg, #d32f2f, #c62828);
        }

        .toast-info {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
        }

        .toast-success {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
        }

        .history-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .job-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 123, 0, 0.5);
        }

        .job-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffb37c;
        }

        .job-card-detail {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.25rem;
            word-break: break-all;
        }

        .no-items-message {
            text-align: center;
            padding: 3rem;
            color: white;
            grid-column: 1 / -1;
        }

        .no-items-icon {
            font-size: 4rem;
            opacity: 0.5;
        }

        .no-items-text {
            margin-top: 1rem;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-out;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3a8a, #3c2a68);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-body {
            overflow-y: auto;
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .modal-close-btn:hover {
            opacity: 1;
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: #ffb37c;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: capitalize;
        }

        .status-badge.processed,
        .status-badge.completed {
            background-color: #2e7d32;
        }

        .status-badge.failed {
            background-color: #c62828;
        }

        .status-badge.pending,
        .status-badge.not_started,
        .status-badge.validating {
            background-color: #ff9800;
            color: #333;
        }

        .status-badge.started,
        .status-badge.processing {
            background-color: #1e3a8a;
        }

        .preview-content {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .login-container {
                padding: 2rem;
                margin: 1rem;
            }

            .progress-steps {
                font-size: 0.8rem;
            }

            .step-circle {
                width: 30px;
                height: 30px;
            }

            .step:not(:last-child)::after {
                top: 15px;
            }

            .data-table th,
            .data-table td {
                white-space: normal;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div id="loginScreen" class="login-screen">
            <div class="login-container">
                <div class="logo-container"><img
                        src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSyZJ-7dYiVbRKZIQMirchNjfri3xFyHMtRzw&s"
                        alt="Logo" class="logo">
                    <h1 class="login-title">BatchProcessor Pro</h1>
                    <p class="login-subtitle">Advanced Batch Processing Platform</p>
                </div>
                <form id="loginForm">
                    <div class="form-group"><input type="email" id="email" class="form-input"
                            placeholder="Email Address" required></div>
                    <div class="form-group"><input type="password" id="password" class="form-input"
                            placeholder="Password" required></div><button type="submit" class="login-btn"><span
                            id="loginText">Sign In</span>
                        <div id="loginSpinner" class="spinner hidden"
                            style="width: 20px; height: 20px; border-width: 2px; margin: 0 auto;"></div>
                    </button>
                </form>
            </div>
        </div>

        <div id="dashboard" class="dashboard">
            <nav class="navbar">
                <div class="nav-logo"><img
                        src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSyZJ-7dYiVbRKZIQMirchNjfri3xFyHMtRzw&s"
                        alt="Logo" class="nav-logo-icon"> BatchProcessor Pro</div>
                <div class="nav-menu"><a href="#" class="nav-item active" data-section="create-job">Create Job</a><a
                        href="#" class="nav-item" data-section="uploaded-files-history">Uploaded Files History</a><a
                        href="#" class="nav-item" data-section="batch-jobs-history">Batch Jobs History</a></div>
                <div class="profile-menu"><button class="profile-btn" id="profileBtn"><span
                            id="profileInitial">U</span></button>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-info"><strong>User Name:</strong> <span id="userName">User Name</span></div>
                        <div class="profile-info"><strong>Email:</strong> <span id="userEmail">user@email.com</span>
                        </div>
                        <div class="profile-info"><strong>Role:</strong> <span id="userRole">User</span></div><button
                            class="logout-btn" id="logoutBtn">Logout</button>
                    </div>
                </div>
            </nav>

            <main class="main-content">
                <section id="create-job" class="section active">
                    <div id="createJobFormContainer">
                        <h2 class="section-title">Create New Batch Job</h2>
                        <div class="progress-container">
                            <div class="progress-steps">
                                <div class="step active" data-step="1">
                                    <div class="step-circle">1</div>
                                    <div class="step-label">Job & File</div>
                                </div>
                                <div class="step" data-step="2">
                                    <div class="step-circle">2</div>
                                    <div class="step-label">Preview</div>
                                </div>
                                <div class="step" data-step="3">
                                    <div class="step-circle">3</div>
                                    <div class="step-label">Prompt</div>
                                </div>
                                <div class="step" data-step="4">
                                    <div class="step-circle">4</div>
                                    <div class="step-label">Mapping</div>
                                </div>
                                <div class="step" data-step="5">
                                    <div class="step-circle">5</div>
                                    <div class="step-label">Credentials</div>
                                </div>
                                <div class="step" data-step="6">
                                    <div class="step-circle">6</div>
                                    <div class="step-label">Submit</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-step active" data-step="1">
                            <div class="form-group"><label for="jobTitle" class="form-label">Job Title</label><input
                                    type="text" id="jobTitle" class="form-input"
                                    placeholder="e.g., Analyze Customer Feedback" maxlength="30" required>
                                <div id="jobTitleError" class="form-error">Job Title is required.</div>
                            </div>
                            <div class="file-upload" id="fileUploadArea">
                                <div class="upload-icon">üìÅ</div>
                                <h3 style="color: white; margin-bottom: 0.5rem;">Upload your CSV or Excel file</h3>
                                <p style="color: rgba(255, 255, 255, 0.8);">Drag and drop your file here or click to
                                    browse</p><input type="file" id="fileInput" accept=".csv,.xlsx,.xls"
                                    style="display: none;">
                            </div>
                            <div id="fileInfo" class="hidden"
                                style="color: white; margin-top: 1rem; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                            </div>
                            <div id="fileError" class="form-error">A file is required.</div>
                            <div class="form-navigation"><button class="btn btn-primary" id="cj_next_1"
                                    disabled>Next</button></div>
                        </div>
                        <div class="form-step" data-step="2">
                            <h3 style="color: white; margin-bottom: 1rem;">Data Preview (Top 20 Rows)</h3>
                            <div id="dataPreviewContainer" class="data-table-container">
                                <div class="loading" id="previewLoading">
                                    <div class="spinner"></div>
                                    <p>Parsing file and generating preview...</p>
                                </div>
                            </div>
                            <div class="form-navigation"><button class="btn btn-secondary"
                                    id="cj_prev_2">Previous</button><button class="btn btn-primary"
                                    id="cj_next_2">Next</button></div>
                        </div>
                        <div class="form-step" data-step="3">
                            <div class="form-group"><label for="prompt" class="form-label">Prompt</label><textarea
                                    id="prompt" class="form-textarea" rows="8"
                                    placeholder="Enter your prompt here. Use {{column_name}} for placeholders."></textarea>
                                <div id="promptError" class="form-error">Prompt cannot be empty.</div>
                            </div>
                            <div class="form-navigation"><button class="btn btn-secondary"
                                    id="cj_prev_3">Previous</button><button class="btn btn-primary"
                                    id="cj_next_3">Next</button></div>
                        </div>
                        <div class="form-step" data-step="4">
                            <h3 style="color: white; margin-bottom: 1rem;">Map Placeholders to Columns</h3>
                            <div id="mappingContainer" class="data-table-container"></div>
                            <div id="mappingError" class="form-error">Please map all placeholders.</div>
                            <h3 style="color: white; margin: 2rem 0 1rem;">Optional Mapping</h3>
                            <div class="form-group"><label for="uniqueId" class="form-label">Unique ID Column
                                    (Optional)</label><select id="uniqueId" class="form-select"></select></div>
                            <div class="form-group"><label for="outputJson" class="form-label">JSON Object
                                    (Optional)</label><textarea id="outputJson" class="form-textarea" rows="4"
                                    placeholder='e.g., { "key": "value" }'></textarea>
                                <div id="jsonError" class="form-error">Please enter a valid JSON object or leave it
                                    empty.</div>
                            </div>
                            <div class="form-group"><label for="chunkSize" class="form-label">Chunk Size</label>
                                <div class="slider-group">
                                    <div class="slider-container"><input type="range" class="slider" id="chunkSize"
                                            min="1" max="100" value="20" step="10"></div><input type="number"
                                        id="chunkSizeInput" class="form-input slider-value-input" value="20" min="1"
                                        max="100">
                                </div>
                            </div>
                            <div class="form-navigation"><button class="btn btn-secondary"
                                    id="cj_prev_4">Previous</button><button class="btn btn-primary"
                                    id="cj_next_4">Next</button></div>
                        </div>
                        <div class="form-step" data-step="5">
                            <h3 style="color: white; margin-bottom: 1rem;">Credentials</h3>
                            <div class="form-group"><label for="endpoint" class="form-label">Endpoint URL</label><input
                                    type="url" id="endpoint" class="form-input" placeholder="https://your-endpoint.com"
                                    required>
                                <div id="endpointError" class="form-error">Please enter a valid URL.</div>
                            </div>
                            <div class="form-group"><label for="apiKey" class="form-label">API Key</label><input
                                    type="password" id="apiKey" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    required>
                                <div id="apiKeyError" class="form-error">API Key is required.</div>
                            </div>
                            <div class="form-group"><label for="deploymentName" class="form-label">Deployment
                                    Name</label><input type="text" id="deploymentName" class="form-input"
                                    placeholder="e.g., gpt-4-turbo" required>
                                <div id="deploymentNameError" class="form-error">Deployment Name is required.</div>
                            </div>
                            <div class="form-group"><label for="temperature"
                                    class="form-label">Temperature</label><input type="number" id="temperature"
                                    class="form-input" placeholder="e.g., 0.3" min="0" max="2" step="0.1" value="0.3">
                                <div id="temperatureError" class="form-error">Temperature must be between 0 and 2.</div>
                            </div>
                            <div class="form-navigation"><button class="btn btn-secondary"
                                    id="cj_prev_5">Previous</button><button class="btn btn-primary"
                                    id="cj_next_5">Next</button></div>
                        </div>
                        <div class="form-step" data-step="6">
                            <h3 style="color: white; margin-bottom: 1rem;">Overview & Confirmation</h3>
                            <div id="summaryContainer"
                                style="background: rgba(0,0,0,0.2); border-radius: 15px; padding: 1.5rem; color: white; border: 1px solid rgba(255, 255, 255, 0.1);">
                            </div>
                            <div id="processingResult" class="hidden"
                                style="margin-top: 2rem; text-align: center; color: white;"></div>
                            <div class="form-navigation" id="overviewButtons"><button class="btn btn-secondary"
                                    id="cj_prev_6">Previous</button><button class="btn btn-primary" id="submitJobBtn"
                                    style="font-size: 1.2rem; padding: 1rem 2rem;">Create Upload File</button></div>
                        </div>
                    </div>
                    <div id="jobCreationResult" class="hidden" style="color: white; margin-top: 2rem;"></div>
                </section>

                <section id="uploaded-files-history" class="section">
                    <h2 class="section-title">Uploaded Files History</h2>
                    <div id="uploaded-files-container" class="history-container"></div>
                </section>

                <section id="batch-jobs-history" class="section">
                    <h2 class="section-title">Batch Jobs History</h2>
                    <div id="batch-jobs-container" class="history-container"></div>
                </section>
            </main>
        </div>
    </div>

    <div id="filesModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px;"><button class="modal-close-btn"
                data-modal-id="filesModal">&times;</button>
            <h2 id="filesModalTitle" class="modal-title"></h2>
            <div id="filesModalBody" class="modal-body"></div>
        </div>
    </div>
    <div id="downloadPreviewModal" class="modal-overlay" style="z-index: 1001;">
        <div class="modal-content" style="max-width: 700px;"><button class="modal-close-btn"
                data-modal-id="downloadPreviewModal">&times;</button>
            <h2 class="modal-title">Download Preview</h2>
            <div id="downloadPreviewModalBody" class="modal-body"></div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- CONFIGURATION ---
            const API_BASE_URL = 'http://127.0.0.1:8000';
            const LOGIN_ENDPOINT = `${API_BASE_URL}/auth/login`;
            const VALIDATE_TOKEN_ENDPOINT = `${API_BASE_URL}/auth/validate-access-token/`;
            const CREATE_UPLOAD_ENDPOINT = `${API_BASE_URL}/batch-job/process/create-upload-file/`;
            const START_BATCH_ENDPOINT = `${API_BASE_URL}/batch-job/process/start-batch-of-job/`;
            const FETCH_PARENT_JOBS_ENDPOINT = `${API_BASE_URL}/batch-history/history/batch-job/`;
            const FETCH_UPLOADED_FILES_ENDPOINT = `${API_BASE_URL}/batch-history/history/uploaded-file/`;
            const FETCH_BATCH_FILES_ENDPOINT = `${API_BASE_URL}/batch-history/history/batch-file/`;
            const DELETE_UPLOADED_FILE_ENDPOINT = `${API_BASE_URL}/batch-history/delete/uploaded-file/`;
            const DELETE_BATCH_FILE_ENDPOINT = `${API_BASE_URL}/batch-history/delete/batch-file/`;
            const START_SINGLE_BATCH_ENDPOINT = `${API_BASE_URL}/batch-job/process/create-start-batch/`;
            const DOWNLOAD_INPUT_FILE_ENDPOINT = `${API_BASE_URL}/batch-job/download/input-file/`;
            const DOWNLOAD_OUTPUT_FILE_ENDPOINT = `${API_BASE_URL}/batch-job/download/output-file/`;

            // --- STATE ---
            let currentUser = null;
            let jobCreationResultState = null;
            const createJobState = { jobTitle: null, file: null, columns: [], totalRows: 0, previewData: [], prompt: null, placeholders: [], mappings: {}, uniqueIdField: null, outputJson: null, isProcessing: false, config: { chunkSize: 20 }, credentials: { endpoint: null, apiKey: null, deploymentName: null, temperature: 0.3 } };
            const historyState = { parentJobs: [], isLoading: false, hasFetched: false };

            // --- UTILS ---
            const formatFileSize = (bytes) => { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`; };
            const showToast = (message, type = 'info') => { const c = document.getElementById('toastContainer'), t = document.createElement('div'); t.className = `toast toast-${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 100); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, 4000); };
            const downloadBase64File = (base64Data, fileName) => { try { const s = `data:application/octet-stream;base64,${base64Data}`, a = document.createElement("a"); a.href = s; a.download = fileName; a.click(); } catch (e) { showToast('Failed to initiate download.', 'error'); console.error('Download error:', e); } };
            const showError = (id, msg) => { const el = document.getElementById(id); if (el) { el.textContent = msg; el.style.display = 'block'; } };
            const hideError = (id) => { const el = document.getElementById(id); if (el) { el.style.display = 'none'; } };
            const getAuthParams = () => `user_id=${currentUser.user_id}&access_token=${currentUser.access_token}`;

            // --- ROUTING & NAVIGATION ---
            const switchSection = (sectionName) => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector(`.nav-item[data-section="${sectionName}"]`)?.classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionName)?.classList.add('active');

                if ((sectionName === 'uploaded-files-history' || sectionName === 'batch-jobs-history') && !historyState.hasFetched) {
                    fetchParentJobsHistory();
                } else if (sectionName === 'uploaded-files-history') {
                    renderHistoryJobCards('uploaded-files-container', openUploadedFilesModal);
                } else if (sectionName === 'batch-jobs-history') {
                    renderHistoryJobCards('batch-jobs-container', openBatchFilesModal);
                }
                window.history.pushState({ sectionName }, '', `#/${sectionName}`);
            };
            const handleRouting = () => { const section = window.location.hash.slice(2) || 'create-job'; if (currentUser) switchSection(section); else { document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('dashboard').style.display = 'none'; } };

            // --- AUTH ---
            const login = async (e, t) => { document.getElementById("loginText").style.display = "none", document.getElementById("loginSpinner").classList.remove("hidden"), document.querySelector(".login-btn").disabled = !0; try { const s = await fetch(`${LOGIN_ENDPOINT}/${encodeURIComponent(e)}/${encodeURIComponent(t)}`), a = await s.json(); if (!s.ok || 200 !== a.status_code) throw new Error(a.message || "Login failed"); currentUser = a, localStorage.setItem("currentUser", JSON.stringify(currentUser)), showDashboard(), switchSection("create-job") } catch (s) { showToast(s.message, "error") } finally { document.getElementById("loginText").style.display = "inline", document.getElementById("loginSpinner").classList.add("hidden"), document.querySelector(".login-btn").disabled = !1 } }; const logout = e => { localStorage.removeItem("currentUser"), currentUser = null, window.location.hash = "", document.getElementById("loginScreen").style.display = "flex", document.getElementById("dashboard").style.display = "none", e && setTimeout(() => showToast(e, "info"), 100) }; const showDashboard = () => { document.getElementById("loginScreen").style.display = "none", document.getElementById("dashboard").style.display = "block", document.getElementById("userName").textContent = `${currentUser.first_name} ${currentUser.last_name}`, document.getElementById("profileInitial").textContent = (currentUser.first_name[0] + (currentUser.last_name[0] || "")).toUpperCase(), document.getElementById("userEmail").textContent = currentUser.email, document.getElementById("userRole").textContent = currentUser.role }; const checkSession = async () => { const e = localStorage.getItem("currentUser"); if (!e) return void handleRouting(); const t = JSON.parse(e); if (!t.user_id || !t.access_token) return void logout(); try { const s = new URL(VALIDATE_TOKEN_ENDPOINT); s.searchParams.append("user_id", t.user_id), s.searchParams.append("access_token", t.access_token); const a = await fetch(s.toString()); if (!a.ok) return void logout("Session expired. Please log in again."); currentUser = await a.json(), localStorage.setItem("currentUser", JSON.stringify(currentUser)), showDashboard(), handleRouting() } catch (s) { console.error("Session validation failed:", s), logout("Session could not be verified. Please log in again.") } };

            // --- CREATE JOB ---
            const createJobManager = {
                currentStep: 1,
                goToStep(step) { /* ... (unchanged) ... */ this.currentStep = step, document.querySelectorAll("#create-job .step").forEach((t, s) => { t.classList.remove("active", "completed"), s + 1 < step && t.classList.add("completed"), s + 1 === step && t.classList.add("active") }), document.querySelectorAll("#create-job .form-step").forEach(t => { t.classList.remove("active"), parseInt(t.dataset.step) === step && t.classList.add("active") }), 1 === step && this.setupStep1(), 2 === step && this.setupStep2(), 3 === step && this.setupStep3(), 4 === step && this.setupStep4(), 5 === step && this.setupStep5(), 6 === step && this.setupStep6() },
                setupStep1() { this.validateStep1(); },
                validateStep1() { const nextBtn = document.getElementById('cj_next_1'); const isTitleValid = document.getElementById('jobTitle').value.trim().length > 0; const isFileValid = !!createJobState.file; isTitleValid ? hideError('jobTitleError') : showError('jobTitleError', 'Job Title is required.'); isFileValid ? hideError('fileError') : showError('fileError', 'A file is required.'); const isValid = isTitleValid && isFileValid; nextBtn.disabled = !isValid; return isValid; },
                async setupStep2() {
                    const previewContainer = document.getElementById('dataPreviewContainer');
                    const nextBtn = document.getElementById('cj_next_2');
                    nextBtn.disabled = true;
                    if (createJobState.previewData.length > 0) { this.renderPreviewTable(previewContainer); nextBtn.disabled = false; return; }
                    const loading = document.getElementById('previewLoading');
                    loading.style.display = 'block'; previewContainer.innerHTML = ''; previewContainer.appendChild(loading);
                    try {
                        const data = await this.parseFile(createJobState.file);
                        createJobState.columns = data.headers;
                        createJobState.previewData = data.rows;
                        createJobState.totalRows = data.totalRows;
                        this.renderPreviewTable(previewContainer);
                        nextBtn.disabled = false;
                    } catch (error) { previewContainer.innerHTML = `<p style="color: #ffcdd2;">Error parsing file: ${error.message}</p>`; }
                },
                renderPreviewTable(container) { const table = document.createElement('table'); table.className = 'data-table'; table.innerHTML = `<thead><tr>${createJobState.columns.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${createJobState.previewData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>`; container.innerHTML = ''; container.appendChild(table); },

                // --- CORRECTED FILE PARSING LOGIC ---
                parseFile(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const data = event.target.result;
                                const workbook = XLSX.read(data, { type: file.name.toLowerCase().endsWith('.csv') ? 'binary' : 'array' });
                                const sheetName = workbook.SheetNames[0];
                                if (!sheetName) return reject(new Error('No sheets found in the file.'));
                                const worksheet = workbook.Sheets[sheetName];
                                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                                if (json.length === 0) return reject(new Error('The file appears to be empty.'));
                                let headers = json[0];
                                if (!Array.isArray(headers)) return reject(new Error('Could not parse a valid header row.'));
                                headers = headers.map(h => (h ? String(h).replace(/^\uFEFF/, '').trim() : ''));
                                const dataRows = json.slice(1);
                                resolve({ headers: headers, rows: dataRows.slice(0, 20), totalRows: dataRows.length });
                            } catch (err) {
                                console.error("File Parsing Error:", err);
                                reject(new Error('There was an error parsing the file. Please check the file format.'));
                            }
                        };
                        reader.onerror = (error) => { console.error("FileReader Error:", error); reject(new Error('Could not read the file.')); };
                        if (file.name.toLowerCase().endsWith('.csv')) { reader.readAsBinaryString(file); }
                        else { reader.readAsArrayBuffer(file); }
                    });
                },
                // --- End of corrected function ---

                setupStep3() { this.validateStep3(); },
                validateStep3() { const nextBtn = document.getElementById('cj_next_3'); const isValid = document.getElementById('prompt').value.trim().length > 0; isValid ? hideError('promptError') : showError('promptError', 'Prompt cannot be empty.'); nextBtn.disabled = !isValid; return isValid; },
                setupStep4() { /* ... (unchanged) ... */ const e = document.getElementById("mappingContainer"), t = document.getElementById("uniqueId"), s = "<option value=\"\">-- Select Column --</option>" + createJobState.columns.map(e => `<option value="${e}">${e}</option>`).join(""); t.innerHTML = "<option value=\"\">None</option>" + s, createJobState.placeholders.length > 0 ? (e.innerHTML = `<table class="data-table"><thead><tr><th>Placeholder</th><th>Column Name</th></tr></thead><tbody>${createJobState.placeholders.map(e => `<tr><td>{{${e}}}</td><td><select class="form-select mapping-select" data-placeholder="${e}">${s}</select></td></tr>`).join("")}</tbody></table>`, document.querySelectorAll(".mapping-select").forEach(e => e.addEventListener("input", () => this.validateStep4()))) : e.innerHTML = '<p style="color: white;">No placeholders found in the prompt.</p>', this.validateStep4() },
                validateStep4() { const nextBtn = document.getElementById('cj_next_4'); let allMapped = Array.from(document.querySelectorAll('.mapping-select')).every(sel => sel.value); allMapped ? hideError('mappingError') : showError('mappingError', 'Please map all placeholders.'); let isJsonValid = true; const jsonValue = document.getElementById('outputJson').value.trim(); if (jsonValue) { try { JSON.parse(jsonValue); hideError('jsonError'); } catch (e) { isJsonValid = false; showError('jsonError', 'Invalid JSON format.'); } } else { hideError('jsonError'); } nextBtn.disabled = !(allMapped && isJsonValid); return allMapped && isJsonValid; },
                setupStep5() { this.validateStep5(); },
                validateStep5() { /* ... (unchanged) ... */ const e = document.getElementById("cj_next_5"), t = [{ id: "endpoint", type: "url", errorId: "endpointError", msg: "Please enter a valid URL." }, { id: "apiKey", type: "text", errorId: "apiKeyError", msg: "API Key is required." }, { id: "deploymentName", type: "text", errorId: "deploymentNameError", msg: "Deployment Name is required." }, { id: "temperature", type: "range", errorId: "temperatureError", msg: "Temperature must be between 0 and 2." }], s = t.every(e => { const t = document.getElementById(e.id); let s = !1; if ("url" === e.type) try { new URL(t.value), s = !0 } catch (e) { s = !1 } else "range" === e.type ? (s = parseFloat(t.value), s = !isNaN(s) && s >= 0 && s <= 2) : s = t.value.trim().length > 0; return s ? hideError(e.errorId) : showError(e.errorId, e.msg), s }); return e.disabled = !s, s },
                setupStep6() { document.getElementById('summaryContainer').innerHTML = `<p><strong>Job Title:</strong> ${createJobState.jobTitle}</p><p><strong>File Name:</strong> ${createJobState.file.name}</p><p><strong>Total Rows:</strong> ${createJobState.totalRows.toLocaleString()}</p><p><strong>Chunk Size:</strong> ${createJobState.config.chunkSize}</p>`; document.getElementById('processingResult').classList.add('hidden'); document.getElementById('overviewButtons').classList.remove('hidden'); },
                async submitJob() { /* ... (unchanged) ... */ if (createJobState.isProcessing) return; createJobState.isProcessing = !0; const e = document.getElementById("overviewButtons"), t = document.getElementById("processingResult"); e.classList.add("hidden"), t.classList.remove("hidden"), t.innerHTML = '<div class="loading"><div class="spinner"></div><p>Uploading file and creating job...</p></div>'; const s = { job_title: createJobState.jobTitle, prompt: createJobState.prompt, placeholder_field: createJobState.mappings, unique_id_field: createJobState.uniqueIdField, output_field: createJobState.outputJson, config: createJobState.config, credentials: createJobState.credentials }, a = new FormData; a.append("file", createJobState.file), a.append("description", JSON.stringify(s)); const r = new URL(CREATE_UPLOAD_ENDPOINT); r.searchParams.append("user_id", currentUser.user_id), r.searchParams.append("access_token", currentUser.access_token); try { const e = await fetch(r.toString(), { method: "POST", body: a }), s = await e.json(); if (!e.ok) throw new Error(s.detail || `API Error (${e.status})`); showToast(s.message || "Job created successfully", "success"), displayJobCreationResult(s) } catch (s) { console.error("API Call Failed:", s), t.innerHTML = `<p style="color: #ffcdd2;">Error: ${s.message}</p>`, e.classList.remove("hidden") } finally { createJobState.isProcessing = !1 } },
                init() { /* ... (unchanged) ... */ document.getElementById("cj_next_1").addEventListener("click", () => { this.validateStep1() && (createJobState.jobTitle = document.getElementById("jobTitle").value, Object.assign(createJobState, { columns: [], previewData: [], totalRows: 0, prompt: null, placeholders: [], mappings: {}, uniqueIdField: null, outputJson: null }), this.goToStep(2)) }), document.getElementById("cj_prev_2").addEventListener("click", () => this.goToStep(1)), document.getElementById("cj_next_2").addEventListener("click", () => this.goToStep(3)), document.getElementById("cj_prev_3").addEventListener("click", () => this.goToStep(2)), document.getElementById("cj_next_3").addEventListener("click", () => { this.validateStep3() && (createJobState.prompt = document.getElementById("prompt").value, createJobState.placeholders = [...new Set(Array.from(createJobState.prompt.matchAll(/{{\s*(\w+)\s*}}/g), e => e[1]))], this.goToStep(4)) }), document.getElementById("cj_prev_4").addEventListener("click", () => this.goToStep(3)), document.getElementById("cj_next_4").addEventListener("click", () => { if (this.validateStep4()) { createJobState.mappings = {}, document.querySelectorAll(".mapping-select").forEach(e => { createJobState.mappings[e.dataset.placeholder] = e.value }), createJobState.uniqueIdField = document.getElementById("uniqueId").value || null; const e = document.getElementById("outputJson").value.trim(); createJobState.outputJson = e ? JSON.parse(e) : null, createJobState.config.chunkSize = parseInt(document.getElementById("chunkSizeInput").value), this.goToStep(5) } }), document.getElementById("cj_prev_5").addEventListener("click", () => this.goToStep(4)), document.getElementById("cj_next_5").addEventListener("click", () => { this.validateStep5() && (createJobState.credentials.endpoint = document.getElementById("endpoint").value, createJobState.credentials.apiKey = document.getElementById("apiKey").value, createJobState.credentials.deploymentName = document.getElementById("deploymentName").value, createJobState.credentials.temperature = parseFloat(document.getElementById("temperature").value), this.goToStep(6)) }), document.getElementById("cj_prev_6").addEventListener("click", () => { this.isProcessing = !1, this.goToStep(5) }), document.getElementById("submitJobBtn").addEventListener("click", () => this.submitJob()); const e = document.getElementById("fileInput"), t = document.getElementById("fileUploadArea"), s = e => { e.length > 0 && (createJobState.file = e[0], document.getElementById("fileInfo").innerHTML = `<strong>File:</strong> ${createJobState.file.name} | <strong>Size:</strong> ${formatFileSize(createJobState.file.size)}`, document.getElementById("fileInfo").classList.remove("hidden"), this.validateStep1()) }; t.addEventListener("click", () => e.click()), t.addEventListener("dragover", e => { e.preventDefault(), t.classList.add("drag-over") }), t.addEventListener("dragleave", () => t.classList.remove("drag-over")), t.addEventListener("drop", e => { e.preventDefault(), t.classList.remove("drag-over"), s(e.dataTransfer.files) }), e.addEventListener("change", e => s(e.target.files)), document.getElementById("jobTitle").addEventListener("input", () => this.validateStep1()), document.getElementById("prompt").addEventListener("input", () => this.validateStep3()), document.getElementById("outputJson").addEventListener("input", () => this.validateStep4()), document.getElementById("chunkSize").addEventListener("input", e => { document.getElementById("chunkSizeInput").value = e.target.value, this.validateStep4() }), document.getElementById("chunkSizeInput").addEventListener("input", e => { document.getElementById("chunkSize").value = e.target.value, this.validateStep4() }), ["endpoint", "apiKey", "deploymentName", "temperature"].forEach(e => document.getElementById(e).addEventListener("input", () => this.validateStep5())), this.setupStep1() }
            };
            const displayJobCreationResult = e => { jobCreationResultState = e; const t = document.getElementById("jobCreationResult"), s = document.getElementById("createJobFormContainer"), a = `<div class="result-summary-grid"><div class="summary-card"><div class="summary-card-title">Job Title</div><div class="summary-card-value">${e.job_title}</div></div><div class="summary-card"><div class="summary-card-title">Rows Processed</div><div class="summary-card-value">${e.total_test_rows_processed}</div></div><div class="summary-card"><div class="summary-card-title">Chunks Created</div><div class="summary-card-value">${e.chunks}</div></div></div>`; let r = "<h3>Data Preview</h3>"; e.row_preview_data && e.row_preview_data.length > 0 ? r += `<div class="data-table-container"><table class="data-table"><thead><tr>${Object.keys(e.row_preview_data[0]).map(e => `<th>${e.replace(/_/g, " ")}</th>`).join("")}</tr></thead><tbody>${e.row_preview_data.map(e => `<tr>${Object.keys(e).map(t => `<td>${JSON.stringify(e[t])}</td>`).join("")}</tr>`).join("")}</tbody></table></div>` : r += "<p>No preview data available.</p>", t.innerHTML = `<h2 class="section-title">File Uploaded Successfully</h2>${a}${r}<div style="text-align:center; margin: 2rem 0;"><button class="btn btn-secondary" id="downloadInputCsvBtn">Download Input CSV File</button></div><p style="text-align:center; margin: 1rem 0;">If the preview is correct, press the button below to start the batch processing. You can also start it later from the 'Uploaded Files History' section.</p><div class="form-navigation" style="text-align: center;"><button class="btn btn-primary" id="startBatchBtn" style="font-size: 1.2rem; padding: 1rem 2rem;">Start Batch of ${e.chunks} Chunks</button></div>`, s.classList.add("hidden"), t.classList.remove("hidden"), document.getElementById("downloadInputCsvBtn").addEventListener("click", () => { downloadBase64File(jobCreationResultState.file_data, `${jobCreationResultState.job_title}_input.csv`) }), document.getElementById("startBatchBtn").addEventListener("click", startBatch) };
            const startBatch = async () => { const e = document.getElementById("startBatchBtn"); if (!jobCreationResultState || !jobCreationResultState.job_id) return void showToast("Job ID is missing. Cannot start batch.", "error"); e.disabled = !0, e.textContent = "Starting..."; const t = new URL(START_BATCH_ENDPOINT); t.searchParams.append("user_id", currentUser.user_id), t.searchParams.append("access_token", currentUser.access_token), t.searchParams.append("job_id", jobCreationResultState.job_id); try { const s = await fetch(t.toString(), { method: "POST" }), a = await s.json(); if (!s.ok) throw new Error(a.message || "Failed to start batch."); showToast(a.message || "Batch started successfully!", "success"), e.textContent = "Batch Started!", e.style.background = "#2e7d32" } catch (s) { showToast(s.message, "error"), e.disabled = !1, e.textContent = `Start Batch of ${jobCreationResultState.chunks} Chunks` } };

            // --- HISTORY TABS LOGIC ---
            const fetchParentJobsHistory = async () => {
                historyState.isLoading = true; historyState.hasFetched = true;
                renderHistoryJobCards('uploaded-files-container', openUploadedFilesModal);
                renderHistoryJobCards('batch-jobs-container', openBatchFilesModal);
                try {
                    const response = await fetch(`${FETCH_PARENT_JOBS_ENDPOINT}?${getAuthParams()}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to fetch job history');
                    historyState.parentJobs = data.jobs || [];
                } catch (error) { showToast(error.message, 'error'); historyState.parentJobs = []; }
                finally {
                    historyState.isLoading = false;
                    renderHistoryJobCards('uploaded-files-container', openUploadedFilesModal);
                    renderHistoryJobCards('batch-jobs-container', openBatchFilesModal);
                }
            };

            const renderHistoryJobCards = (containerId, clickHandler) => {
                const container = document.getElementById(containerId);
                if (historyState.isLoading) { container.innerHTML = `<div class="loading" style="grid-column: 1 / -1;"><div class="spinner"></div><p>Fetching Job History...</p></div>`; return; }
                if (historyState.parentJobs.length === 0) { container.innerHTML = `<div class="no-items-message"><div class="no-items-icon">üìÇ</div><p class="no-items-text">No job history found.</p></div>`; return; }
                container.innerHTML = historyState.parentJobs.map(job => `<div class="job-card" data-job-id="${job.id}" data-job-title="${job.job_title}"><h3 class="job-card-title">${job.job_title}</h3><p class="job-card-detail"><strong>File:</strong> ${job.file_name}</p><p class="job-card-detail"><strong>Chunks:</strong> ${job.chunks}</p><p class="job-card-detail"><strong>Created:</strong> ${new Date(job.created_at).toLocaleString()}</p></div>`).join('');
                container.querySelectorAll('.job-card').forEach(card => card.addEventListener('click', () => clickHandler(card.dataset.jobId, card.dataset.jobTitle)));
            };

            // --- Uploaded Files Modal ---
            const openUploadedFilesModal = async (jobId, jobTitle) => {
                const modalBody = document.getElementById('filesModalBody');
                document.getElementById('filesModalTitle').textContent = `Uploaded Files for: ${jobTitle}`;
                document.getElementById('filesModal').classList.add('show');
                modalBody.innerHTML = `<div class="loading"><div class="spinner"></div><p>Fetching file details...</p></div>`;
                try {
                    const response = await fetch(`${FETCH_UPLOADED_FILES_ENDPOINT}?${getAuthParams()}&job_id=${jobId}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to fetch files');
                    modalBody.innerHTML = (data.jobs && data.jobs.length > 0) ? `<div class="data-table-container"><table class="data-table"><thead><tr><th>Chunk</th><th>File Status</th><th>Batch Status</th><th>Rows</th><th>Actions</th></tr></thead><tbody>
                        ${data.jobs.map(file => `<tr><td>${file.chunk_no.replace('_', ' ')}</td><td><span class="status-badge ${file.file_status}">${file.file_status.replace(/_/g, ' ')}</span></td><td><span class="status-badge ${file.batch_status}">${file.batch_status.replace(/_/g, ' ')}</span></td><td>${file.total_rows_processed}</td>
                            <td><button class="btn btn-secondary btn-sm" onclick="app.startSingleBatch('${file.file_id}', '${jobId}', this)" ${file.batch_status === 'started' ? 'disabled' : ''}>Start</button><button class="btn btn-secondary btn-sm" onclick="app.downloadAndPreviewFile('${file.file_id}', '${jobId}')">Input</button><button class="btn btn-secondary btn-sm" onclick="app.deleteUploadedFile('${file.file_id}', '${jobId}', '${jobTitle}')" style="background: #c62828;">Del</button></td></tr>`).join('')}
                        </tbody></table></div>` : `<p class="no-items-text">No uploaded files found for this job.</p>`;
                } catch (error) { showToast(error.message, 'error'); modalBody.innerHTML = `<p style="color: #ffcdd2; text-align: center;">${error.message}</p>`; }
            };
            const deleteUploadedFile = async (fileId, jobId, jobTitle) => {
                if (!confirm(`Delete file chunk: ${fileId}?`)) return;
                try {
                    const response = await fetch(`${DELETE_UPLOADED_FILE_ENDPOINT}?${getAuthParams()}&file_id=${fileId}`, { method: 'DELETE' });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to delete file.');
                    showToast(data.message, 'success'); openUploadedFilesModal(jobId, jobTitle);
                } catch (error) { showToast(error.message, 'error'); }
            };
            const startSingleBatch = async (fileId, jobId, btn) => {
                btn.disabled = true; btn.textContent = '...';
                try {
                    const response = await fetch(`${START_SINGLE_BATCH_ENDPOINT}?${getAuthParams()}&job_id=${jobId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ file_ids: [fileId] }) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to start batch.');
                    showToast(data.message, 'success'); openUploadedFilesModal(jobId, document.getElementById('filesModalTitle').textContent.replace('Uploaded Files for: ', ''));
                } catch (error) { showToast(error.message, 'error'); btn.disabled = false; btn.textContent = 'Start'; }
            };

            // --- Batch Jobs Modal ---
            const openBatchFilesModal = async (jobId, jobTitle) => {
                const modalBody = document.getElementById('filesModalBody');
                document.getElementById('filesModalTitle').textContent = `Batch Status for: ${jobTitle}`;
                document.getElementById('filesModal').classList.add('show');
                modalBody.innerHTML = `<div class="loading"><div class="spinner"></div><p>Fetching batch status...</p></div>`;
                try {
                    const response = await fetch(`${FETCH_BATCH_FILES_ENDPOINT}?${getAuthParams()}&job_id=${jobId}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to fetch batch files');
                    modalBody.innerHTML = (data.jobs && data.jobs.length > 0) ? `<div class="data-table-container"><table class="data-table"><thead><tr><th>Chunk</th><th>Status</th><th>Rows</th><th>Actions</th></tr></thead><tbody>
                        ${data.jobs.map(batch => `<tr><td>${batch.chunk_no.replace('_', ' ')}</td><td><span class="status-badge ${batch.status}">${batch.status.replace(/_/g, ' ')}</span></td><td>${batch.total_rows_processed}</td>
                            <td><button class="btn btn-secondary btn-sm" onclick="app.downloadAndPreviewFile('${batch.file_id}', '${jobId}')">Input</button><button class="btn btn-secondary btn-sm" onclick="app.downloadAndPreviewOutputFile('${batch.batch_id}', '${jobId}')" ${batch.status !== 'completed' ? 'disabled' : ''}>Output</button><button class="btn btn-secondary btn-sm" onclick="app.deleteBatchFile('${batch.batch_id}', '${jobId}', '${jobTitle}')" style="background: #c62828;">Del</button></td></tr>`).join('')}
                        </tbody></table></div>` : `<p class="no-items-text">No batches found for this job.</p>`;
                } catch (error) { showToast(error.message, 'error'); modalBody.innerHTML = `<p style="color: #ffcdd2; text-align: center;">${error.message}</p>`; }
            };
            const deleteBatchFile = async (batchId, jobId, jobTitle) => {
                if (!confirm(`Delete batch process: ${batchId}?`)) return;
                try {
                    const response = await fetch(`${DELETE_BATCH_FILE_ENDPOINT}?${getAuthParams()}&batch_id=${batchId}`, { method: 'DELETE' });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to delete batch.');
                    showToast(data.message, 'success'); openBatchFilesModal(jobId, jobTitle);
                } catch (error) { showToast(error.message, 'error'); }
            };

            // --- Download & Preview Logic ---
            const downloadAndPreviewFile = async (fileId, jobId) => {
                showToast('Preparing input file download...', 'info');
                try {
                    const response = await fetch(`${DOWNLOAD_INPUT_FILE_ENDPOINT}?${getAuthParams()}&job_id=${jobId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ file_ids: [fileId] }) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to get file data.');
                    const fileData = data.input_files_csv_data[0];
                    if (fileData && fileData.file_data) { downloadBase64File(fileData.file_data, `input_${fileId}.csv`); openInputPreviewModal(fileData); }
                    else { throw new Error('No input file data received.'); }
                } catch (error) { showToast(error.message, 'error'); }
            };
            const downloadAndPreviewOutputFile = async (batchId, jobId) => {
                showToast('Preparing output file download...', 'info');
                try {
                    const response = await fetch(`${DOWNLOAD_OUTPUT_FILE_ENDPOINT}?${getAuthParams()}&job_id=${jobId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ batch_ids: [batchId] }) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Failed to get file data.');
                    const fileData = data.output_files_csv_data[0];
                    if (fileData && fileData.file_data) { downloadBase64File(fileData.file_data, `output_${batchId}.csv`); openOutputPreviewModal(fileData); }
                    else { throw new Error('No output file data received.'); }
                } catch (error) { showToast(error.message, 'error'); }
            };
            const openInputPreviewModal = (fileData) => {
                const modalBody = document.getElementById('downloadPreviewModalBody');
                modalBody.innerHTML = `<h4>Preview for ${fileData.total_test_rows_processed} rows in ${fileData.file_id}</h4>
                    ${fileData.row_preview_data.map(row => `<div class="summary-card" style="text-align: left;"><p><strong>Unique ID:</strong> ${row.unique_id}</p><p><strong>Model:</strong> ${row.model_name}</p><p><strong>Prompt:</strong></p><div class="preview-content">${JSON.stringify(row.message_prompt, null, 2)}</div></div>`).join('')}`;
                document.getElementById('downloadPreviewModal').classList.add('show');
            };
            const openOutputPreviewModal = (fileData) => {
                const modalBody = document.getElementById('downloadPreviewModalBody');
                modalBody.innerHTML = `<h4>Preview for ${fileData.total_test_rows_processed} rows in ${fileData.batch_id}</h4>
                    ${fileData.row_preview_data.map(row => `<div class="summary-card" style="text-align: left;"><p><strong>Unique ID:</strong> ${row.unique_id}</p><p><strong>Tokens:</strong> ${row.total_tokens} (P: ${row.prompt_tokens} + C: ${row.completion_tokens})</p><p><strong>Raw Output:</strong></p><div class="preview-content">${row.raw_output}</div></div>`).join('')}`;
                document.getElementById('downloadPreviewModal').classList.add('show');
            };

            // --- INITIALIZATION ---
            document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); login(document.getElementById('email').value, document.getElementById('password').value); });
            document.getElementById('profileBtn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('profileDropdown').classList.toggle('show'); });
            document.addEventListener('click', (e) => { if (!document.querySelector('.profile-menu').contains(e.target)) document.getElementById('profileDropdown').classList.remove('show'); });
            document.getElementById('logoutBtn').addEventListener('click', () => logout('You have been logged out.'));
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); switchSection(item.dataset.section); }));
            window.addEventListener('popstate', handleRouting);
            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => document.getElementById(btn.dataset.modalId).classList.remove('show')));
            window.app = { deleteUploadedFile, startSingleBatch, downloadAndPreviewFile, deleteBatchFile, downloadAndPreviewOutputFile };
            checkSession();
            createJobManager.init();
        });
    </script>
</body>

</html>